# https://www.keycloak.org/operator/basic-deployment
# https://www.keycloak.org/operator/advanced-configuratio
# https://www.keycloak.org/server/configuration -- noting this is only for config not available in the operator that you have to implement using 'additionalOptions'
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: keycloak-cert
  namespace: keycloak
spec:
  secretName: keycloak-tls
  issuerRef:
    name: letsencrypt-dns01-prod 
    kind: ClusterIssuer
  dnsNames:
    - keycloak.rockyroad.rocks
---
apiVersion: k8s.keycloak.org/v2alpha1
kind: Keycloak
metadata:
  name: keycloak
  namespace: keycloak
spec:
  instances: 1
  hostname:
    hostname: https://keycloak.rockyroad.rocks
    strict: true
    # https://www.keycloak.org/server/hostname
    backchannelDynamic: true # enable a split hostname approach - separate URL for backchannel requests, enabling internal communication while maintaining the use of a public URL for frontchannel request
  http:
    httpEnabled: true
    tlsSecret: keycloak-tls
    httpPort: 8080
    httpsPort: 8443
  # proxy: # deprecated
  #   proxyAddressForwarding: true
  db:
    vendor: postgres
    host: postgres-service
    database: keycloak
    usernameSecret:
      name: keycloak-postgres-externalsecrets
      key: keycloak-postgres-username
    passwordSecret:
      name: keycloak-postgres-externalsecrets
      key: keycloak-postgres-secret
  bootstrapAdmin:
    user:
      secret: keycloak-externalsecrets # must contain username and password keys
  ingress:
    enabled: true
    # ingressClassName: nginx # not valid
    tlsSecret: keycloak-tls
    annotations:
      kubernetes.io/ingress.class: nginx
      # cert-manager.io/cluster-issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/proxy-body-size: "50m"
      # gethomepage.dev/description: Identity and Access Management
      # gethomepage.dev/enabled: "true"
      # gethomepage.dev/group: Network Services
      # gethomepage.dev/icon: keycloak
      # gethomepage.dev/name: Keycloak
  networkPolicy:
    enabled: true
    http:
      - namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: argocd # allow mealie to connect to the service
      - namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: mealie # allow mealie to connect to the service
      - namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: wallos # allow wallos to connect to the service
  additionalOptions:
    - name: hostname-debug
      value: 'true'
      # This allows us to test against: 
      #    curl http://keycloak-service.keycloak.svc.cluster.local:8080/realms/rockyroadrocks/.well-known/openid-configuration

# Note that realm login is here: https://keycloak.rockyroad.rocks/realms/rockyroadrocks/account
# OIDC well-known config is here: https://keycloak.rockyroad.rocks/realms/rockyroadrocks/.well-known/openid-configuration

# ---
# apiVersion: networking.k8s.io/v1
# kind: Ingress
# metadata:
#   name: keycloak
#   namespace: keycloak
#   annotations:
#     # cert-manager.io/cluster-issuer: letsencrypt-prod # Not required as we already defined a secret
#     gethomepage.dev/description: Identity and Access Management
#     gethomepage.dev/enabled: "true"
#     gethomepage.dev/group: Network Services
#     gethomepage.dev/icon: keycloak
#     gethomepage.dev/name: Keycloak
# spec:
#   ingressClassName: nginx   # change if you use traefik/cilium
#   tls:
#     - hosts:
#         - keycloak.rockyroad.rocks
#       secretName: keycloak-tls
#   rules:
#     - host: keycloak.rockyroad.rocks
#       http:
#         paths:
#           - path: /
#             pathType: Prefix
#             backend:
#               service:
#                 name: keycloak-service
#                 port:
#                   number: 8443


# kubectl get secret example-kc-initial-admin -o jsonpath='{.data.username}' | base64 --decode
# kubectl get secret example-kc-initial-admin -o jsonpath='{.data.password}' | base64 --decode